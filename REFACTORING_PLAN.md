# AgentX ä»£ç ç»“æ„é‡æ„è®¡åˆ’

## ç›®æ ‡
ä¼˜åŒ–ä»£ç ç»„ç»‡ï¼Œæé«˜å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

---

## å½“å‰é—®é¢˜è¯Šæ–­

### 1. æ ¹ç›®å½•æ–‡ä»¶æ··ä¹±
- âŒ 16+ ä¸ªé¡¶å±‚æ–‡ä»¶ç¼ºä¹åˆ†ç±»
- âŒ é¢æ¿ã€ä¸šåŠ¡é€»è¾‘ã€åŸºç¡€è®¾æ–½æ··åœ¨ä¸€èµ·
- âŒ éš¾ä»¥å¿«é€Ÿå®šä½åŠŸèƒ½æ¨¡å—

### 2. å•ä¸ªæ–‡ä»¶è¿‡å¤§
- âŒ `conversation_acp.rs` (1307 è¡Œ) - åŒ…å«æ¸²æŸ“é€»è¾‘ã€çŠ¶æ€ç®¡ç†ã€äº‹ä»¶å¤„ç†
- âŒ `code_editor.rs` (1052 è¡Œ) - LSP é€»è¾‘å’Œ UI æ¸²æŸ“è€¦åˆ
- âŒ `task_list.rs` (797 è¡Œ) - æ•°æ®åŠ è½½å’Œ UI æ··åˆ

### 3. æ¨¡å—èŒè´£ä¸æ¸…
- âŒ `lib.rs` æ‰¿æ‹…è¿‡å¤šåˆå§‹åŒ–å’Œæ³¨å†Œé€»è¾‘
- âŒ äº‹ä»¶æ€»çº¿æ•£è½å„å¤„ï¼Œç¼ºä¹ç»Ÿä¸€ç®¡ç†
- âŒ é¢æ¿å®ç°ç¼ºä¹ç»Ÿä¸€ç»„ç»‡

### 4. ä¾èµ–å…³ç³»å¤æ‚
- âŒ å¤šä¸ªæ¨¡å—ç›´æ¥ä¾èµ–å…¨å±€ `AppState`
- âŒ æ½œåœ¨å¾ªç¯ä¾èµ–é£é™©

---

## é‡æ„æ–¹æ¡ˆ

### é˜¶æ®µ 1: ç›®å½•é‡ç»„ (1-2å¤©)

#### æ–°ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ main.rs                    # å…¥å£
â”œâ”€â”€ lib.rs                     # ç²¾ç®€ï¼šä»…å¯¼å‡ºæ ¸å¿ƒæ¨¡å—
â”‚
â”œâ”€â”€ app/                       # åº”ç”¨çº§æ¨¡å— âœ… å·²ä¼˜åŒ–
â”‚   â”œâ”€â”€ actions.rs
â”‚   â”œâ”€â”€ app_state.rs
â”‚   â”œâ”€â”€ app_menus.rs
â”‚   â”œâ”€â”€ menu.rs
â”‚   â”œâ”€â”€ themes.rs
â”‚   â””â”€â”€ title_bar.rs
â”‚
â”œâ”€â”€ workspace/                 # å·¥ä½œåŒºç®¡ç† âœ… å·²ä¼˜åŒ–
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ actions.rs
â”‚
â”œâ”€â”€ panels/                    # ğŸ†• é¢æ¿æ¨¡å— (æ–°å¢)
â”‚   â”œâ”€â”€ mod.rs                # å¯¼å‡ºæ‰€æœ‰é¢æ¿
â”‚   â”œâ”€â”€ dock_panel.rs         # ä»æ ¹ç›®å½•ç§»åŠ¨
â”‚   â”‚
â”‚   â”œâ”€â”€ conversation/         # ğŸ†• å¯¹è¯é¢æ¿å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ panel.rs          # ä» conversation_acp.rs æ‹†åˆ†
â”‚   â”‚   â”œâ”€â”€ message_renderer.rs
â”‚   â”‚   â”œâ”€â”€ tool_renderer.rs
â”‚   â”‚   â””â”€â”€ state.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ editor/               # ğŸ†• ç¼–è¾‘å™¨å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ panel.rs          # ä» code_editor.rs æ‹†åˆ†
â”‚   â”‚   â”œâ”€â”€ lsp_client.rs
â”‚   â”‚   â””â”€â”€ diagnostics.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ task_list/            # ğŸ†• ä»»åŠ¡åˆ—è¡¨å­æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ panel.rs          # ä» task_list.rs æ‹†åˆ†
â”‚   â”‚   â”œâ”€â”€ task_loader.rs
â”‚   â”‚   â””â”€â”€ task_renderer.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ chat_input.rs         # ä»æ ¹ç›®å½•ç§»åŠ¨
â”‚   â””â”€â”€ welcome_panel.rs      # ä»æ ¹ç›®å½•ç§»åŠ¨
â”‚
â”œâ”€â”€ core/                      # ğŸ†• æ ¸å¿ƒåŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ config.rs             # ä»æ ¹ç›®å½•ç§»åŠ¨
â”‚   â”‚
â”‚   â”œâ”€â”€ event_bus/            # ğŸ†• äº‹ä»¶æ€»çº¿æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ session_bus.rs    # ä»æ ¹ç›®å½•ç§»åŠ¨
â”‚   â”‚   â””â”€â”€ permission_bus.rs # ä»æ ¹ç›®å½•ç§»åŠ¨
â”‚   â”‚
â”‚   â””â”€â”€ agent/                # ğŸ†• Agent å®¢æˆ·ç«¯æ¨¡å—
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ client.rs         # ä» acp_client.rs é‡å‘½å
â”‚       â”œâ”€â”€ handle.rs         # Agent handle é€»è¾‘
â”‚       â””â”€â”€ gui_client.rs     # ä»æ ¹ç›®å½•ç§»åŠ¨
â”‚
â”œâ”€â”€ components/                # UI ç»„ä»¶ âœ… å·²ä¼˜åŒ–
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ agent_message.rs
â”‚   â”œâ”€â”€ user_message.rs
â”‚   â”œâ”€â”€ tool_call_item.rs
â”‚   â”œâ”€â”€ agent_todo_list.rs
â”‚   â”œâ”€â”€ chat_input_box.rs
â”‚   â”œâ”€â”€ task_list_item.rs
â”‚   â”œâ”€â”€ permission_request.rs
â”‚   â””â”€â”€ fixtures/
â”‚
â”œâ”€â”€ schemas/                   # æ•°æ®æ¨¡å‹ âœ… å·²ä¼˜åŒ–
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ conversation_schema.rs
â”‚   â””â”€â”€ task_schema.rs
â”‚
â””â”€â”€ utils/                     # å·¥å…·å‡½æ•° âœ… å·²ä¼˜åŒ–
    â”œâ”€â”€ mod.rs
    â””â”€â”€ time.rs
```

#### é‡æ„ä»»åŠ¡æ¸…å•

**ç¬¬ 1 æ­¥: åˆ›å»ºæ–°ç›®å½•ç»“æ„**
- [ ] åˆ›å»º `src/panels/` ç›®å½•
- [ ] åˆ›å»º `src/panels/conversation/` ç›®å½•
- [ ] åˆ›å»º `src/panels/editor/` ç›®å½•
- [ ] åˆ›å»º `src/panels/task_list/` ç›®å½•
- [ ] åˆ›å»º `src/core/` ç›®å½•
- [ ] åˆ›å»º `src/core/event_bus/` ç›®å½•
- [ ] åˆ›å»º `src/core/agent/` ç›®å½•

**ç¬¬ 2 æ­¥: ç§»åŠ¨å’Œé‡å‘½åæ–‡ä»¶**
- [ ] ç§»åŠ¨ `dock_panel.rs` â†’ `panels/dock_panel.rs`
- [ ] ç§»åŠ¨ `chat_input.rs` â†’ `panels/chat_input.rs`
- [ ] ç§»åŠ¨ `welcome_panel.rs` â†’ `panels/welcome_panel.rs`
- [ ] ç§»åŠ¨ `session_bus.rs` â†’ `core/event_bus/session_bus.rs`
- [ ] ç§»åŠ¨ `permission_bus.rs` â†’ `core/event_bus/permission_bus.rs`
- [ ] ç§»åŠ¨ `acp_client.rs` â†’ `core/agent/client.rs`
- [ ] ç§»åŠ¨ `gui_client.rs` â†’ `core/agent/gui_client.rs` (å¦‚æœå­˜åœ¨)
- [ ] ç§»åŠ¨ `config.rs` â†’ `core/config.rs`

**ç¬¬ 3 æ­¥: æ‹†åˆ†å¤§æ–‡ä»¶**
- [ ] æ‹†åˆ† `conversation_acp.rs` (1307 è¡Œ) â†’ `panels/conversation/` å¤šä¸ªæ–‡ä»¶
- [ ] æ‹†åˆ† `code_editor.rs` (1052 è¡Œ) â†’ `panels/editor/` å¤šä¸ªæ–‡ä»¶
- [ ] æ‹†åˆ† `task_list.rs` (797 è¡Œ) â†’ `panels/task_list/` å¤šä¸ªæ–‡ä»¶

**ç¬¬ 4 æ­¥: æ›´æ–°æ¨¡å—å¯¼å‡º**
- [ ] æ›´æ–° `src/lib.rs` çš„å¯¼å…¥è·¯å¾„
- [ ] æ›´æ–° `src/main.rs` çš„å¯¼å…¥è·¯å¾„
- [ ] åœ¨æ¯ä¸ªæ–°ç›®å½•åˆ›å»º `mod.rs` æ–‡ä»¶

**ç¬¬ 5 æ­¥: ä¿®å¤ç¼–è¯‘é”™è¯¯**
- [ ] ä¿®å¤æ‰€æœ‰ `use` è¯­å¥çš„è·¯å¾„
- [ ] è¿è¡Œ `cargo check` å¹¶ä¿®å¤é”™è¯¯
- [ ] è¿è¡Œ `cargo test` ç¡®ä¿æµ‹è¯•é€šè¿‡

---

### é˜¶æ®µ 2: æ‹†åˆ†å¤§æ–‡ä»¶ (2-3å¤©)

#### 2.1 æ‹†åˆ† `conversation_acp.rs` (1307 è¡Œ)

**ç›®æ ‡**: å°†å•ä¸€å¤§æ–‡ä»¶æ‹†åˆ†ä¸ºèŒè´£æ¸…æ™°çš„å¤šä¸ªæ¨¡å—

**æ–°ç»“æ„**:
```
panels/conversation/
â”œâ”€â”€ mod.rs                    # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ panel.rs                  # ConversationPanelAcp ä¸»ç»“æ„ (~300 è¡Œ)
â”œâ”€â”€ state.rs                  # çŠ¶æ€ç®¡ç†å’Œæ•°æ®ç»“æ„ (~200 è¡Œ)
â”œâ”€â”€ message_renderer.rs       # æ¶ˆæ¯æ¸²æŸ“é€»è¾‘ (~300 è¡Œ)
â”œâ”€â”€ tool_renderer.rs          # å·¥å…·è°ƒç”¨æ¸²æŸ“ (~200 è¡Œ)
â”œâ”€â”€ event_handler.rs          # äº‹ä»¶æ€»çº¿è®¢é˜…å’Œå¤„ç† (~200 è¡Œ)
â””â”€â”€ types.rs                  # è¾…åŠ© trait å’Œç±»å‹æ‰©å±• (~100 è¡Œ)
```

**æ‹†åˆ†åŸåˆ™**:
- `panel.rs`: `ConversationPanelAcp` ç»“æ„å®šä¹‰ã€`new()` æ–¹æ³•ã€`Render` trait å®ç°
- `state.rs`: `MessageItem`, `ResourceInfo`, `ToolCallInfo` ç­‰æ•°æ®ç»“æ„
- `message_renderer.rs`: `render_user_message()`, `render_agent_message()` ç­‰
- `tool_renderer.rs`: `render_tool_calls()` å’Œå·¥å…·è°ƒç”¨ç›¸å…³ UI
- `event_handler.rs`: `subscribe_to_session_bus()`, `handle_session_update()` ç­‰
- `types.rs`: `ToolKindExt`, `ToolCallStatusExt` ç­‰è¾…åŠ© trait

#### 2.2 æ‹†åˆ† `code_editor.rs` (1052 è¡Œ)

**æ–°ç»“æ„**:
```
panels/editor/
â”œâ”€â”€ mod.rs                    # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ panel.rs                  # CodeEditorPanel ä¸»ç»“æ„ (~200 è¡Œ)
â”œâ”€â”€ lsp_client.rs             # LSP å®¢æˆ·ç«¯é€»è¾‘ (~400 è¡Œ)
â”œâ”€â”€ diagnostics.rs            # è¯Šæ–­ä¿¡æ¯å¤„ç† (~200 è¡Œ)
â”œâ”€â”€ completion.rs             # è‡ªåŠ¨è¡¥å…¨é€»è¾‘ (~150 è¡Œ)
â””â”€â”€ syntax_highlight.rs       # è¯­æ³•é«˜äº® (~100 è¡Œ)
```

#### 2.3 æ‹†åˆ† `task_list.rs` (797 è¡Œ)

**æ–°ç»“æ„**:
```
panels/task_list/
â”œâ”€â”€ mod.rs                    # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ panel.rs                  # ListTaskPanel ä¸»ç»“æ„ (~200 è¡Œ)
â”œâ”€â”€ task_loader.rs            # ä»»åŠ¡æ•°æ®åŠ è½½ (~150 è¡Œ)
â”œâ”€â”€ task_renderer.rs          # ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“ (~250 è¡Œ)
â””â”€â”€ session_manager.rs        # ä¼šè¯ç®¡ç†é€»è¾‘ (~150 è¡Œ)
```

---

### é˜¶æ®µ 3: ä¼˜åŒ–ä¾èµ–å…³ç³» (1-2å¤©)

#### 3.1 å¼•å…¥æœåŠ¡å±‚

**é—®é¢˜**: å¤šä¸ªç»„ä»¶ç›´æ¥ä¾èµ– `AppState`ï¼Œå¯¼è‡´è€¦åˆåº¦é«˜

**æ–¹æ¡ˆ**: åˆ›å»ºæœåŠ¡æŠ½è±¡å±‚

```
src/services/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ session_service.rs        # ä¼šè¯ç®¡ç†æœåŠ¡
â”œâ”€â”€ agent_service.rs          # Agent äº¤äº’æœåŠ¡
â””â”€â”€ state_service.rs          # çŠ¶æ€ç®¡ç†æœåŠ¡
```

**ç¤ºä¾‹**:
```rust
// services/session_service.rs
pub struct SessionService {
    app_state: Entity<AppState>,
    session_bus: SessionUpdateBusContainer,
}

impl SessionService {
    pub fn create_session(&self, task_name: String) -> String { /* ... */ }
    pub fn get_active_session(&self) -> Option<String> { /* ... */ }
    pub fn publish_message(&self, session_id: String, message: SessionUpdate) { /* ... */ }
}
```

#### 3.2 ä¾èµ–æ³¨å…¥

å°† `AppState` çš„ç›´æ¥å¼•ç”¨æ”¹ä¸ºé€šè¿‡æœåŠ¡æ³¨å…¥ï¼š

```rust
// ä¿®æ”¹å‰
pub struct ConversationPanelAcp {
    app_state: Entity<AppState>,
    session_bus: SessionUpdateBusContainer,
}

// ä¿®æ”¹å
pub struct ConversationPanelAcp {
    session_service: Arc<SessionService>,
}
```

---

### é˜¶æ®µ 4: æå–é€šç”¨ç»„ä»¶ (å¯é€‰ï¼Œ1-2å¤©)

#### 4.1 åˆ›å»º UI å·¥å…·æ¨¡å—

```
src/ui_helpers/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ markdown_renderer.rs      # é€šç”¨ Markdown æ¸²æŸ“
â”œâ”€â”€ code_block.rs             # ä»£ç å—ç»„ä»¶
â””â”€â”€ status_badge.rs           # çŠ¶æ€å¾½ç« ç»„ä»¶
```

#### 4.2 åˆ›å»ºæ•°æ®è½¬æ¢å±‚

```
src/adapters/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ acp_adapter.rs            # ACP åè®®é€‚é…å™¨
â””â”€â”€ schema_adapter.rs         # Schema è½¬æ¢é€‚é…å™¨
```

---

## é¢„æœŸæ”¶ç›Š

### å¯ç»´æŠ¤æ€§ â¬†ï¸
- âœ… æ–‡ä»¶å¤§å°é™ä½ 60%+ï¼ˆ1300 è¡Œ â†’ ~300 è¡Œ/æ–‡ä»¶ï¼‰
- âœ… èŒè´£æ¸…æ™°ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
- âœ… å‡å°‘è®¤çŸ¥è´Ÿæ‹…

### å¯æ‰©å±•æ€§ â¬†ï¸
- âœ… æ–°é¢æ¿æŒ‰ç›®å½•æ¨¡æ¿æ·»åŠ 
- âœ… åŠŸèƒ½æ¨¡å—ç‹¬ç«‹æ¼”åŒ–
- âœ… æ›´å®¹æ˜“æ·»åŠ å•å…ƒæµ‹è¯•

### å¯æµ‹è¯•æ€§ â¬†ï¸
- âœ… å°æ–‡ä»¶æ›´å®¹æ˜“ç¼–å†™æµ‹è¯•
- âœ… æœåŠ¡å±‚å¯ mock
- âœ… ä¸šåŠ¡é€»è¾‘ä¸ UI åˆ†ç¦»

### åä½œæ•ˆç‡ â¬†ï¸
- âœ… æ¨¡å—è¾¹ç•Œæ¸…æ™°ï¼Œå‡å°‘åˆå¹¶å†²çª
- âœ… æ–°æˆå‘˜å¿«é€Ÿç†è§£ä»£ç ç»“æ„

---

## é£é™©è¯„ä¼°

### ä½é£é™© âœ…
- **ç›®å½•é‡ç»„**: ä»…ç§»åŠ¨æ–‡ä»¶ï¼ŒIDE æ”¯æŒè‡ªåŠ¨é‡æ„
- **æ–‡ä»¶æ‹†åˆ†**: ä¸æ”¹å˜å…¬å…± APIï¼Œå†…éƒ¨é‡æ„

### ä¸­é£é™© âš ï¸
- **ä¾èµ–æ³¨å…¥**: éœ€è¦ä¿®æ”¹å¤šä¸ªè°ƒç”¨ç‚¹
- **æœåŠ¡å±‚å¼•å…¥**: éœ€è¦è®¾è®¡è‰¯å¥½çš„æ¥å£

### å»ºè®®
1. **æ¸è¿›å¼é‡æ„**: ä¸€æ¬¡å®Œæˆä¸€ä¸ªé˜¶æ®µ
2. **å……åˆ†æµ‹è¯•**: æ¯ä¸ªé˜¶æ®µå®Œæˆåè¿è¡Œå®Œæ•´æµ‹è¯•
3. **æäº¤é¢‘ç¹**: æ¯ä¸ªå°æ­¥éª¤éƒ½æäº¤ï¼Œä¾¿äºå›æ»š
4. **ä¿æŒå¯ç¼–è¯‘**: ç¡®ä¿æ¯æ¬¡æäº¤éƒ½èƒ½ç¼–è¯‘é€šè¿‡

---

## å®æ–½æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|-----|------|---------|--------|
| 1 | ç›®å½•é‡ç»„ + æ–‡ä»¶ç§»åŠ¨ | 1-2 å¤© | ğŸ”´ é«˜ |
| 2 | æ‹†åˆ†å¤§æ–‡ä»¶ | 2-3 å¤© | ğŸ”´ é«˜ |
| 3 | ä¼˜åŒ–ä¾èµ–å…³ç³» | 1-2 å¤© | ğŸŸ¡ ä¸­ |
| 4 | æå–é€šç”¨ç»„ä»¶ | 1-2 å¤© | ğŸŸ¢ ä½ |

**æ€»è®¡**: 5-9 ä¸ªå·¥ä½œæ—¥

---

## åç»­ä¼˜åŒ–æ–¹å‘

### 1. æ€§èƒ½ä¼˜åŒ–
- [ ] å¼•å…¥è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§é‡æ¶ˆæ¯åœºæ™¯ï¼‰
- [ ] ä¼˜åŒ–äº‹ä»¶æ€»çº¿æ€§èƒ½
- [ ] å‡å°‘ä¸å¿…è¦çš„ `cx.notify()` è°ƒç”¨

### 2. ä»£ç è´¨é‡
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼ˆç›®æ ‡ 70%+ï¼‰
- [ ] å¼•å…¥ Clippy lint è§„åˆ™
- [ ] æ·»åŠ  API æ–‡æ¡£æ³¨é‡Š

### 3. æ¶æ„æ”¹è¿›
- [ ] å¼•å…¥å‘½ä»¤æ¨¡å¼ï¼ˆCommand Patternï¼‰å¤„ç†ç”¨æˆ·æ“ä½œ
- [ ] å®ç°æ’¤é”€/é‡åšåŠŸèƒ½
- [ ] çŠ¶æ€ç®¡ç†æ”¹ç”¨ Flux æ¶æ„

---

## å‚è€ƒèµ„æº

- [Rust API Guidelines](https://rust-lang.github.io/api-guidelines/)
- [GPUI Architecture Patterns](https://github.com/zed-industries/zed)
- [Clean Architecture in Rust](https://www.youtube.com/watch?v=0iyhuJdVvRk)
